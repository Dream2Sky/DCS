
@{
    ViewBag.Title = "ImportPage";
    Layout = "~/Views/_LayoutPage.cshtml";
}
<style>
    .td-btn {
        text-align: right;
    }

    .div-single-data, .div-excel-data {
        display: none;
    }

    .alert-active {
        display: block;
    }

    .table {
        text-align: center;
    }

    #form-addCustomItem input[type='text'] {
        width: 200px;
    }

    #form-CustomItems table td {
        border: 1px solid #dddddd;
        padding-left: 10px;
        padding-right: 10px;
    }
</style>
<script type="text/template" id="customerItemTemplate">
    {{each itemList as item}}
    <tr>
        <td colspan="2">{{item.Content}}</td>
        <td colspan="5">
            <input type="text" name="{{item.Name}}" class="form-control" />
        </td>
        <td colspan="2">
            <input type="button" name="btn-Update" value="修改" class="btn btn-primary" onclick="Upate('{{item.Name}}','{{item.Content}}');" />
            <input type="button" name="btn-Delete" value="删除" class="btn btn-danger" onclick="Delete('{{item.Name}}')" />
        </td>
    </tr>
    {{/each}}
</script>
<div class="row">
    <div class="col-md-12">
        <ol class="breadcrumb">
            <li><a href="/">管理后台</a></li>
            <li class="active">数据导入</li>
        </ol>
    </div>
    <div class="container">
        <div class="alert alert-error div-single-data">
            <a class="close" data-dismiss="alert">×</a>
            <strong>添加此条数据失败! </strong>请联系管理员
        </div>
        <label>
            数据单条录入
        </label>
        <form>
            <table class="table table-bordered">
                <tr>
                    <td colspan="1">
                        客户姓名
                    </td>
                    <td colspan="2">
                        <input type="text" class="form-control" name="customerName">
                    </td>
                    <td colspan="1">
                        性別
                    </td>
                    <td colspan="2">
                        <select name="sex" class="form-control">
                            <option selected="selected">男</option>
                            <option>女</option>
                        </select>
                    </td>
                    <td colspan="1">
                        年齡
                    </td>
                    <td colspan="2">
                        <input type="text" class="form-control" name="age">
                    </td>
                </tr>
                <tr>
                    <td colspan="1">
                        省市
                    </td>
                    <td colspan="8">
                        <input type="text" class="form-control" name="address">
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        所屬行業
                    </td>
                    <td colspan="2">
                        <input type="text" class="form-control" name="address">
                    </td>
                    <td colspan="1">
                        職業
                    </td>
                    <td colspan="4">
                        <input type="text" class="form-control" name="address">
                    </td>
                </tr>
                <tr>
                    <td colspan="1">
                        婚否
                    </td>
                    <td colspan="1">
                        <select name="children" class="form-control">
                            <option selected="selected">有</option>
                            <option>无</option>
                        </select>
                    </td>
                    <td colspan="1">
                        子女
                    </td>
                    <td colspan="1">
                        <select name="children" class="form-control">
                            <option selected="selected">有</option>
                            <option>无</option>
                        </select>
                    </td>
                    <td colspan="1">
                        年收入
                    </td>
                    <td colspan="4">
                        <input type="text" class="form-control" name="address">
                    </td>
                </tr>
                <tr>
                    <td colspan="1">
                        車否
                    </td>
                    <td colspan="1">
                        <select name="children" class="form-control">
                            <option selected="selected">有</option>
                            <option>无</option>
                        </select>
                    </td>
                    <td colspan="1">
                        房否
                    </td>
                    <td colspan="1">
                        <select name="children" class="form-control">
                            <option selected="selected">有</option>
                            <option>无</option>
                        </select>
                    </td>
                    <td colspan="1">愛好</td>
                    <td colspan="4">
                        <input type="text" class="form-control" name="address">
                    </td>
                </tr>
                <tr>
                    <td colspan="1">電話</td>
                    <td colspan="4">
                        <input type="text" class="form-control" name="address">
                    </td>
                    <td colspan="1">qq</td>
                    <td colspan="3">
                        <input type="text" class="form-control" name="address">
                    </td>
                </tr>
                <tr>
                    <td colspan="1">微信</td>
                    <td colspan="3">
                        <input type="text" class="form-control" name="address">
                    </td>

                    <td colspan="1">郵箱</td>
                    <td colspan="4">
                        <input type="text" class="form-control" name="address">
                    </td>
                </tr>
                <tr>
                    <td colspan="1">投資項目</td>
                    <td colspan="2">
                        <input type="text" class="form-control" name="address">
                    </td>
                    <td colspan="1">投資理念</td>
                    <td colspan="3">
                        <input type="text" class="form-control" />
                    </td>
                    <td colspan="1">投資年限</td>
                    <td colspan="1">
                        <input type="text" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td colspan="1">備注1</td>
                    <td colspan="8">
                        <input type="text" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td colspan="1">備注2</td>
                    <td colspan="8">
                        <input type="text" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td colspan="1">備注3</td>
                    <td colspan="8">
                        <input type="text" class="form-control" />
                    </td>
                </tr>
            </table>
        </form>
        <hr />
        <label>
            自定义字段
        </label>
        <form id="form-CustomItems">
            <table class="table table-bordered"></table>
            <div class="form-group">
                <div class="alert alert-error alert-getCustomItem" style="display:none;">
                    <a class="close" data-dismiss="alert">×</a>
                    <span id="span-message"></span>
                </div>
            </div>
        </form>
        <hr />
        <label>
            添加自定义字段
        </label>
        <form id="form-addCustomItem">
            <div class="form-group">
                <input type="text" name="CustomItemName" class="form-control" required data-bv-notempty-message="自定义项名称不能为空" />
            </div>
            <div class="form-group">
                <div class="alert alert-error alert-customItem" style="display:none;">
                    <a class="close" data-dismiss="alert">×</a>
                    <span id="span-message"></span>
                </div>
            </div>
            <button type="button" class="btn btn-primary btn-Add">添加</button>
            <div class="alert alert-error alert-addCustomItem" style="display:none;">
                <a class="close" data-dismiss="alert">×</a>
                <span id="span-message"></span>
            </div>
        </form>
        <hr />
        <label>
            数据导入
        </label>
        <form id="form-data">
            <div class="form-group">
                <label for="exampleInputFile">Excel数据文件导入</label>
                <input type="file" name="fileCollection" accept=".xls,.xlsx">
                <p class="help-block">请选择要导入的excel文件.</p>
            </div>
            <div class="alert alert-error div-excel-data">
                <a class="close" data-dismiss="alert">×</a>
                <strong>导入数据失败! </strong>请检查您的上传的excel表格格式是否正确
            </div>
            <button class="btn btn-primary" type="button" onclick="UploadFile();">导入</button>
        </form>
    </div>
</div>
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">修改信息</h4>
            </div>
            <div class="modal-body">
                <form class="update-form">
                    <div class="form-group">
                        <input type="hidden" name="customItemName" value="" class="form-control" disabled />
                    </div>
                    <div class="form-group">
                        <input type="text" name="customItemContent" value="" class="form-control" required data-bv-notempty-message="自定义项的名称不为空" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary btn-save">保存</button>
            </div>
            <div class="alert alert-error alert-updateCustomItem" style="display:none;">
                <a class="close" data-dismiss="alert">×</a>
                <span id="span-message"></span>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">删除自定义项</h4>
            </div>
            <div class="modal-body">
                是否确定删除该自定义项？
                <input type="hidden" name="customItemName" value="" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger btn-confirm">删除</button>
            </div>
            <div class="alert alert-error alert-deletecustomItem" style="display:none;">
                <a class="close" data-dismiss="alert">×</a>
                <span id="span-message"></span>
            </div>
        </div>
    </div>
</div>
<script src="~/Content/js/bootstrapValidator.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        GetCustomItemList();
    });

    function GetCustomItemList() {
        $.ajax({
            url: "/Admin/GetCustomItems",
            type: "POST",
            success: function (data) {
                if (data.state == "error") {
                    $(".alert-getCustomItem").show();
                    $(".alert-getCustomItem span").html(data.message);
                }
                else if (data.state == "success") {
                    var customItemList = {
                        itemList: JSON.parse(data.data)
                    };

                    var html = template("customerItemTemplate", customItemList);
                    $("#form-CustomItems table").html(html);
                }
            },
            error: function () {
                $(".alert-getCustomItem").show();
                $(".alert-getCustomItem span").html("系统错误，添加自定义项失败");
            }
        });
    }

    // 添加自定义项
    function AddCustomItem(action, customItemName) {
        $.ajax({
            url: action,
            type: "POST",
            data: {
                customItemName: customItemName
            },
            success: function (data) {
                if (data.state == "error") {
                    $(".alert-customItem").show();
                    $(".alert-customItem span").html(data.message);
                }
                else if (data.state == "success") {
                    var customitemList = {
                        itemList: JSON.parse("[" + data.data + "]")
                    };

                    var html = template("customerItemTemplate", customitemList);
                    $("#form-CustomItems table").append(html);
                }
            },
            error: function () {
                $(".alert-customItem").show();
                $(".alert-customItem span").html("系统错误，添加自定义项失败");
            }
        });
    }

    $(".btn-Add").on("click", function () {
        $("#form-addCustomItem").bootstrapValidator();
        var name = $("#form-addCustomItem input[name='CustomItemName']").val();
        AddCustomItem("/Admin/AddCustomItems", name);

        $("#form-addCustomItem input[name='CustomItemName']").val("");
    });

    // 弹出修改框
    function Upate(customItemName, customItemContent) {
        $("#updateModal").modal();
        $("#updateModal input[name='customItemName']").val(customItemName);
        $("#updateModal input[name='customItemContent']").val(customItemContent);
    }

    // 修改自定义项
    function UpdateCustomItem(action, customItemName, customItemContent) {
        var result = false;
        $.ajax({
            url: action,
            type: "POST",
            async: false,
            data: {
                customItemName: customItemName,
                customItemContent: customItemContent
            },
            success: function (data) {
                if (data.state == "error") {
                    $("#updateModal .alert-updateCustomItem").show();
                    $("#updateModal .alert-updateCustomItem span").html(data.message);

                    result = false;
                }
                else if (data.state == "success") {
                    result = true;
                } 
            },
            error: function () {
                $("#updateModal .alert-updateCustomItem").show();
                $("#updateModal .alert-updateCustomItem span").html("系统错误，修改自定义项失败");

                result = false;
            }
        });

        return result;                       
    }

    // 修改
    $(".btn-save").on("click", function () {
        $(".update-form").bootstrapValidator();

        var customItemName = $("#updateModal input[name='customItemName']").val();
        var customItemContent = $("#updateModal input[name='customItemContent']").val();

        if (UpdateCustomItem("/Admin/UpdateCustomItems",customItemName,customItemContent)) {
            window.location.href = "/Admin/ImportPage";
        }
    });

    // 弹出删除框
    function Delete(customItemName) {
        $("#deleteModal").modal();
        $("#deleteModal input[name='customItemName']").val(customItemName);
    }

    // 删除自定义项
    function DeleteCustomItem(action, customItemName) {
        var result = false;

        $.ajax({
            url: action,
            type: "POST",
            async:false,
            data: {
                customItemName:customItemName
            },
            success: function (data) {
                if (data.state == "error") {
                    $("#deleteModal .alert-deletecustomItem").show();
                    $("#deleteModal .alert-deletecustomItem span").html(data.message);
                    
                    result = false;
                }
                else if(data.state == "success") {
                    result = true;
                }
            },
            error: function() {
                $("#deleteModal .alert-deletecustomItem").show();
                $("#deleteModal .alert-deletecustomItem span").html("系统错误，删除自定义项失败");

                result = false;
            }
        });

        return result;
    }

    //删除
    $(".btn-confirm").on("click", function () {
        var customItemName = $("#deleteModal input[name='customItemName']").val();

        if (DeleteCustomItem("/Admin/DeleteCustomItems",customItemName)) {
            window.location.href = "/Admin/ImportPage";
        }
    });
</script>
