
@{
    ViewBag.Title = "MemberList";
    Layout = "~/Views/_LayoutPage.cshtml";
}

<link href="~/Content/css/xcConfirm.css" rel="stylesheet" />
<script src="~/Content/js/arttemplate.js"></script>
@using com.dcs.web.Models
<script type="text/html" id="selectTemplate">
    {{each CompetentList as item}}
    <option>{{item}}</option>
    {{/each}}
</script>
<script type="text/html" id="roleTemplate">
    {{each roleList as item}}
    <label class="radio-inline">
        <input type="radio" name="Role" value={{item.Code}}>{{item.Content}}
    </label>
    {{/each}}
</script>
<script type="text/template" id="member-table">
    <tr>
        <td>{{Name}}</td>
        <td>{{Account}}</td>
        {{if Role == 1}}
        <td>主管</td>
        {{else if Role == 2}}
        <td>收集员</td>
        {{else if Role == 3}}
        <td>普通员工</td>
        {{/if}}
        <td>{{ParentName}}</td>
        <td>
            <button class="btn btn-primary btn-update">修改</button>
            <button class="btn btn-danger btn-delete">删除</button>
        </td>
    </tr>
</script>
<style>
    .container-btn {
        padding-left: 20px;
        padding-right: 20px;
    }

        .container-btn button {
            margin-right: 10px;
        }

        .container-btn table {
            width: 60%;
        }

    .container-add-followitem {
        padding-left: 0px;
    }

        .container-add-followitem form {
            padding-left: 0px;
        }

            .container-add-followitem form .form-group {
                margin-top: 10px;
                margin-bottom: 5px;
            }

                .container-add-followitem form .form-group input {
                    width: 200px;
                }

    .radio-inline {
        text-align: left;
    }

        .radio-inline input {
            width: 20px !important;
        }

    select {
        width: 200px !important;
    }
</style>
<div class="row">
    <div class="col-md-12">
        <ol class="breadcrumb">
            <li><a href="/">管理后台</a></li>
            <li class="active">员工管理</li>
        </ol>
    </div>
    <div class="container">
        <label>
            用户列表
        </label>
        <div class="container container-btn">
            <div class="row">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>账号</th>
                            <th>角色</th>
                            <th>上级</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ViewData["UserList"] as IEnumerable<MemberModel>)
                        {
                            <tr>
                                <td>@item.Name</td>
                                <td>@item.Account</td>
                                @if (item.RoleCode == 1)
                                {
                                    <td>主管</td>
                                }
                                else if (item.RoleCode == 2)
                                {
                                    <td>收集员</td>
                                }
                                else if (item.RoleCode == 3)
                                {
                                    <td>普通员工</td>
                                }
                                <td>@item.ParentName</td>
                                <td>
                                    <button class="btn btn-primary btn-update">修改</button>
                                    <button class="btn btn-danger btn-delete">删除</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <hr />
        <label>添加新用户</label>
        <div class="container container-add-followitem">
            <form id="member-form">
                <div class="form-group">
                    <input type="text" name="Name" class="form-control" required data-bv-notempty-message="用户名不能为空" />
                </div>
                <div class="form-group">
                    <div class="alert alert-error alert-roles" style="display:none;">
                        <a class="close" data-dismiss="alert">×</a>
                        <span id="span-message"></span>
                    </div>
                    <div class="div-role">
                    </div>
                </div>
                <div class="form-group div-competent">
                    <div class="alert alert-error alert-competent" style="display:none;">
                        <a class="close" data-dismiss="alert">×</a>
                        <span id="span-message"></span>
                    </div>
                    <select class="form-control" name="parent"></select>
                    <label id="lab_competnetName"></label>
                </div>
                <button type="button" class="btn btn-primary btn-Add">添加</button>
                <div class="alert alert-error alert-addmember" style="display:none;">
                    <a class="close" data-dismiss="alert">×</a>
                    <span id="span-message"></span>
                </div>
            </form>
        </div>
    </div>
    <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">修改信息</h4>
                </div>
                <div class="modal-body">
                    <form class="update-form">
                        <div class="form-group">
                            <input type="text" name="account" value="" class="form-control" disabled />
                        </div>
                        <div class="form-group">
                            <input type="text" name="name" value="" class="form-control" required data-bv-notempty-message="用户名不能为空" />
                        </div>
                        <div class="form-group">
                            <div class="alert alert-error alert-roles" style="display:none;">
                                <a class="close" data-dismiss="alert">×</a>
                                <span id="span-message"></span>
                            </div>
                            <div class="div-role">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="alert alert-error alert-competent" style="display:none;">
                                <a class="close" data-dismiss="alert">×</a>
                                <span id="span-message"></span>
                            </div>
                            <select class="form-control" name="parent" id="update_select"></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-save">保存</button>
                </div>
                <div class="alert alert-error alert-updatemember" style="display:none;">
                    <a class="close" data-dismiss="alert">×</a>
                    <span id="span-message"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">删除用户</h4>
                </div>
                <div class="modal-body">
                    是否确定删除该用户？
                    <input type="hidden" name="account" value="" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger btn-confirm">删除</button>
                </div>
                <div class="alert alert-error alert-deletememember" style="display:none;">
                    <a class="close" data-dismiss="alert">×</a>
                    <span id="span-message"></span>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/Content/js/xcConfirm.js"></script>
<script>
    $(document).ready(function () {
        $('#member-form').bootstrapValidator();
        GetCompetents();
        GetRoles();
        //var account = $("#member-form select").find("option:selected").text();
        //GetUserName(account);
    });

    function GetCompetents() {
        $.ajax({
            url: "/Admin/GetCompetents",
            type: "POST",
            success: function (data) {
                if (data.state == "error") {
                    console.log(data.message);
                    $(".alert-competent").show();
                    $(".alert-competent span").text(data.message);
                }
                else {
                    console.log("data " + data.data);
                    var data = {
                        CompetentList: JSON.parse(data.data)
                    };
                    var html = template("selectTemplate", data);
                    $("select").html(html);
                }
            }
        })
    }

    function GetRoles() {
        $.ajax({
            url: "/Admin/GetRoles",
            type: "POST",
            success: function (data) {
                if (data.state == "error") {
                    $(".alert-roleList").show();
                    $(".alert-roleList span").text(data.message);
                }
                else {
                    var role = {
                        roleList
                            : JSON.parse(data.data)
                    };
                    console.log(role);
                    var html = template("roleTemplate", role);
                    $(".div-role").html(html);

                    $("#member-form input[type='radio']").eq(0).attr("checked", "checked");
                }
            }
        });
    }

    function AddMember(action, currentUserRole, role) {
        var result = false;
        $.ajax({
            url: action,
            type: "POST",
            async: false,
            data: {
                Name: $("#member-form input[name='Name']").val(),
                RoleCode: role,
                ParentName: role == currentUserRole ? null : $("#member-form select[name='parent']").find("option:selected").text()
            },
            success: function (data) {
                if (data.state == "error") {
                    $(".alert-addmember").show();
                    $(".alert-addmember span").text(data.message);
                    result = false;
                }
                else if (data.state == "success") {
                    var member = {
                        Name: data.data.Name,
                        Account: data.data.Account,
                        Role: data.data.RoleCode,
                        ParentName: data.data.ParentName
                    };
                    var html = template("member-table", member);
                    $("table tbody").append(html);

                    result = true;
                }
            },
            error: function () {
                $(".alert-addmember").show();
                $(".alert-addmember span").text("系统错误，添加用户失败");
                result = false;
            }

        });

        return result;
    }

    function UpdateMember(action, currentUserRole, role) {
        var result = false;
        $.ajax({
            url: action,
            type: "POST",
            async: false,
            data: {
                Account: $("#updateModal input[name='account']").val(),
                Name: $("#updateModal input[name='name']").val(),
                RoleCode: $("#updateModal input[type='radio']:checked").val(),
                ParentName: role == currentUserRole ? null : $("#updateModal select[name='parent']").find("option:selected").text()
            },
            success: function (data) {
                if (data.state == "error") {
                    $(".alert-updatemember").show();
                    $(".alert-updatemember #span-message").text(data.message);

                    result = false;
                }
                else if (data.state == "success") {
                    result = true;
                }
            },
            error: function () {
                $(".alert-updatemember").show();
                $(".alert-updatemember #span-message").text("系統錯誤，修改用戶信息失敗");

                result = false;
            }
        });

        return result;
    }

    function DeleteMember(action, account) {
        $.ajax({
            url: action,
            type: "POST",
            async:false,
            data: {
                Account: account
            },
            success: function (data) {
                if (data.state == "error") {
                    $(".alert-deletemember").show();
                    $(".alert-deletemember span").html("刪除該賬號失敗");
                }
                else if (data.state == "success") {
                    $("table tbody").each(function () {
                        console.log($(this).children().eq(1).text());
                        if ($(this).children().eq(1).text() == account) {
                            console.log($(this));
                            $(this).remove();
                        }
                        return false;
                    });
                }
            },
            error: function () {
                $(".alert-deletemember").show();
                $(".alert-deletemember span").html("系統錯誤，無法刪除該賬號");
                result = false;
            }
        });
    }

    function GetUserName(account) {
        $.ajax({
            url: "/Admin/GetMemberByAccount",
            type: "POST",
            data: {
                Account: account
            },
            success: function (data) {
                if (data.state == "error") {
                    $("#lab_competnetName").html(data.message);
                }
                else if (data.state == "success") {
                    $("#lab_competnetName").html(data.data);
                }
            },
            error: function () {
                $("#lab_competnetName").html("系統錯誤，無法獲取到相應的用戶名");
            }
        })
    }

    $(".btn-Add").on("click", function () {
        $("#member-form").bootstrapValidator();

        // 當前需要提交的角色類型
        var role = $("#member-form input[type='radio']:checked").val();

        // 當前登陸的用戶角色
        var currentRole = sessionStorage.getItem("role");

        var result = AddMember("/Admin/AddMember", currentRole, role);
        console.log(result);
        if (result == true) {
            GetCompetents();
        }
    });

    // 取值到 模態框
    $(".btn-update").on("click", function () {
        $("#updateModal").modal();
        var account = $(this).parent().parent().children().eq(1).text();

        var name = $(this).parent().parent().children().eq(0).text();
        var role = $(this).parent().parent().children().eq(2).text();
        console.log(role);
        var parent = $(this).parent().parent().children().eq(3).text();
        console.log(parent);
        $("#updateModal input[name='account']").val(account);
        $("#updateModal input[name='name']").val(name);

        if (role == "主管") {
            $("#updateModal input[type='radio']").eq(0).attr("checked", true);
        }
        else if (role == "收集员") {
            $("#updateModal input[type='radio']").eq(1).attr("checked", true);
        }
        else if (role == "普通员工") {
            $("#updateModal input[type='radio']").eq(2).attr("checked", true);
        }

        $("#updateModal select[name='parent']").each(function () {
            if ($.trim($(this).text()) == parent) {

                $(this).attr("selected", "true");
                console.log($(this).text());
            }
        });

    });

    $(".btn-save").on("click", function () {
        var account = $.trim($("#updateModal input[name='account']").val());

        if (account == "" || account == null) {
            console.log("賬號爲空");
            return false;
        }

        var currentRole = sessionStorage.getItem("role");
        var role = $("#updateModel input[type='radio']:checked").val();

        if (UpdateMember("/Admin/UpdateMember", currentRole, role)) {
            window.location.href = "/Admin/MemberList";
        }
        $("#updateModel").modal();
    });

    $("#member-form select").on("change", function () {
        var comp = $("#member-form select").find("option:selected").text();
        if (comp != null && comp != "") {
            GetUserName(comp);
        }
        else {
            $("#lab_competnetName").html("沒有相應的賬號");
        }
    });

    $(".btn-delete").on("click", function () {
        $("#deleteModal").modal();
        var account = $(this).parent().parent().children().eq(1).text();
        $("#deleteModal input[name='account']").val(account);
    });

    $(".btn-confirm").on("click", function () {
        var account = $("#deleteModal input[name='account']").val();
        if (DeleteMember("/Admin/DeleteMember", account))
        {
            $("#deleteModal").modal();
        }
        else {
            $(".alert-deletemember").show();
            $(".alert-deletemember span").html("刪除該賬號失敗");
        }
    });

    //var oldAccount;
    //$(".btn-update").on("click", function () {
    //    $('#updateModal').modal();
    //    $(".update-form .memberName").val($(this).parent().parent().children().eq(0).text());
    //    oldAccount = $(".update-form .memberName").val();

    //    $(".update-form .memberId").val($(this).parent().parent().attr("id"));
    //    parent = $(this).parent().parent().children().eq(2).text();

    //    var char = $(this).parent().parent().children().eq(1).text();

    //    console.log(char);

    //    if (char == "收集员") {
    //        $(".update-form #inlineRadio2").attr("checked", true);
    //        $(".update-form select[name='parent']").find("option[text='" + parent + "']").attr("selected", "true");
    //        $(".update-form select").removeAttr("disabled");
    //    }
    //    else if (char == "组长") {
    //        $(".update-form #inlineRadio13").attr("checked", true);
    //        $(".update-form select").attr("disabled","disabled");
    //    }
    //});

    //$(".update-form input[type='radio']").on("change", function() {
    //    var value = $("input[name='role']:checked").val();
    //    if (value == 1) {
    //        $(".update-form select").attr("disabled", "disabled");
    //    }
    //    else {
    //        $(".update-form select").removeAttr("disabled");
    //    }
    //})

    //$(".btn-delete").on("click", function () {
    //    $("#deleteModal").modal();
    //    $("#deleteModal input[name='memberId']").val($(this).parent().parent().attr("id"));
    //    $("#deleteModal input[name='account']").val($(this).parent().parent().children().eq(0).text());
    //    $("#deleteModal input[name='role']").val($(this).parent().parent().children().eq(1).text());
    //});

    //$(".btn-save").on("click", function () {
    //    $(".update-form").bootstrapValidator();

    //    $.ajax({
    //        url: "/Member/Update",
    //        data: {
    //            id: $(".update-form .memberId").val(),
    //            account: $(".update-form .memberName").val(),
    //            role: $(".update-form input[name='role']:checked").val(),
    //            parent: $(".update-form input[name='parent']").find("option:selected").text()
    //        },
    //        type: "POST",
    //        success: function (data) {
    //            if (data.res) {
    //                if (data.member.role == 2) {
    //                    $(".update-form .memberName").val(data.member.account);
    //                    $(".update-form input[name='role']").eq(1).attr("checked", 'checked');
    //                    $("table tbody").children("#" + data.member.memberId).children().eq(0).text(data.member.account);
    //                    $("table tbody").children("#" + data.member.memberId).children().eq(1).text("收集员");

    //                    //$("table tbody").append("<tr id='" + data.member.memberId + "'><td>" + data.member.memberName + "</td><td>普通用户</td><td><button class='btn btn-primary btn-update'>修改</button><button class='btn btn-danger btn-delete'>删除</button></td></tr>");
    //                }
    //                else if (data.member.role == 1) {
    //                    $(".update-form .memberName").val(data.member.account);
    //                    $(".update-form input[name='role']").eq(0).attr("checked", 'checked');
    //                    $("table tbody").children("#" + data.member.id).children().eq(0).text(data.member.account);
    //                    $("table tbody").children("#" + data.member.id).children().eq(1).text("组长");
    //                    $(".update-form select").find("option[text='" + oldAccount + "']").text(data.member.account);
    //                    $("#member-form").find("option[text='" + oldAccount + "']").text(data.member.account);
    //                    //$("table tbody").append("<tr id='" + data.member.memberId + "'><td>" + data.member.memberName + "</td><td>组长</td><td><button class='btn btn-primary btn-update'>修改</button><button class='btn btn-danger btn-delete'>删除</button></td></tr>");
    //                }
    //            }
    //            else {
    //                alert("更新失败");
    //            }

    //            $("#updateModal").modal('hide');
    //        },
    //        error: function () {
    //            alert("系统错误，更新失败");
    //        }
    //    });
    //});

    //$(".btn-confirm").on("click", function () {
    //    $.ajax({
    //        url: "/Member/Delete",
    //        type: "POST",
    //        data: {
    //            memberId: $("input[name='memberId']").val()
    //        },
    //        success: function (data) {
    //            if (data.res) {
    //                $("table tbody").children("#" + $("input[name='memberId']").val()).remove();
    //                if ($("#delete-form input[name='role']").val() == "组长") {
    //                    $("#member-form select").find("option[text='" + $("#delete-form input[name='account']").val() + "']").remove();
    //                    $(".update-form select").find("option[text='" + $("#delete-form input[name='account']").val() + "']").remove();
    //                }
    //                $("#deleteModal").modal('hide');
    //            }
    //            else {
    //                alert("删除失败");
    //            }
    //        },
    //        error: function () {
    //            alert("系统错误，删除失败");
    //        }
    //    })
    //});
</script>